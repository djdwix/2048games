<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ®å½©ç¥¨ - å½©ç¥¨æ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .network-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.1);
            color: #dc3545;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: none;
            border: 1px solid #dc3545;
        }
        
        .network-status.online {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border-color: #28a745;
        }
        
        .god-lottery-info {
            background: linear-gradient(135deg, #8B0000 0%, #FF4500 100%);
            color: #FFD700;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
            border: 2px solid #FFD700;
        }
        
        .god-lottery-info i {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .lucky-king-info {
            background: linear-gradient(135deg, #4B0082 0%, #8A2BE2 100%);
            color: #FFD700;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(75, 0, 130, 0.3);
            border: 2px solid #FFD700;
        }
        
        .lucky-king-info i {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .god-lottery-card .lottery-icon {
            color: #FFD700;
            text-shadow: 0 0 10px #FF4500;
        }
        
        .lucky-king-card .lottery-icon {
            color: #FFD700;
            text-shadow: 0 0 10px #8A2BE2;
        }
        
        .god-lottery-card {
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #8B0000 0%, #B22222 100%);
            color: #FFD700;
        }
        
        .lucky-king-card {
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #4B0082 0%, #8A2BE2 100%);
            color: #FFD700;
        }
        
        .god-lottery-card .lottery-name {
            color: #FFD700;
        }
        
        .lucky-king-card .lottery-name {
            color: #FFD700;
        }
        
        .god-lottery-card .lottery-price {
            color: #FF6347;
            font-size: 1.2em;
        }
        
        .lucky-king-card .lottery-price {
            color: #FFB6C1;
            font-size: 1.2em;
        }
        
        .god-lottery-card .lottery-description {
            color: #FFB6C1;
        }
        
        .lucky-king-card .lottery-description {
            color: #E6E6FA;
        }
        
        .god-lottery-card.selected {
            background: linear-gradient(135deg, #DC143C 0%, #FF4500 100%);
            box-shadow: 0 0 20px #FFD700;
        }
        
        .lucky-king-card.selected {
            background: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
            box-shadow: 0 0 20px #FFD700;
        }
        
        .price-tag {
            display: inline-block;
            background: #FFD700;
            color: #8B0000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .price-tag.premium {
            background: #FF4500;
            color: #FFFFFF;
        }
        
        .price-tag.lucky-king {
            background: #8A2BE2;
            color: #FFFFFF;
        }
        
        .limit-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
            font-size: 0.9em;
            text-align: center;
        }
        
        .limit-warning i {
            color: #ffc107;
            margin-right: 5px;
        }
        
        .identity-required-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #90caf9;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2);
        }
        
        .identity-required-notice i {
            font-size: 1.5em;
            margin-right: 10px;
            color: #1565c0;
        }
        
        .welfare-info {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border: 2px solid #26c6da;
            color: #006064;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(38, 198, 218, 0.3);
        }
        
        .welfare-info i {
            font-size: 1.5em;
            margin-right: 10px;
            color: #006064;
        }
        
        .welfare-bonus {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border: 2px solid #ffd600;
            color: #f57f17;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(255, 214, 0, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .welfare-bonus i {
            font-size: 1.5em;
            margin-right: 10px;
            color: #f57f17;
        }
        
        .lucky-king-bonus {
            background: linear-gradient(135deg, #e6e6fa 0%, #d8bfd8 100%);
            border: 2px solid #8a2be2;
            color: #4b0082;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
            animation: pulse 2s infinite;
        }
        
        .lucky-king-bonus i {
            font-size: 1.5em;
            margin-right: 10px;
            color: #8a2be2;
        }
        
        .anti-code {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4CAF50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .anti-code i {
            font-size: 1.5em;
            margin-right: 10px;
            color: #2e7d32;
        }
        
        .anti-code-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 2px;
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #2e7d32;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            user-select: all;
        }
        
        .anti-code-code:hover {
            background: #f8f9fa;
            transform: scale(1.02);
        }
        
        .anti-code-code.copied {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }
        
        .anti-code-copy-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .anti-code-copy-btn:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }
        
        .anti-code-copy-btn:active {
            transform: translateY(0);
        }
        
        .anti-code-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="networkStatus" class="network-status">
        <i class="fas fa-wifi"></i> ç½‘ç»œè¿æ¥ä¸­...
    </div>
    
    <button onclick="logout()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
    </button>
    
    <div class="container">
        <h1><i class="fas fa-dice"></i> åˆ®å½©ç¥¨æ¸¸æˆ</h1>
        <p class="subtitle">é€‰æ‹©å½©ç¥¨ç±»å‹ï¼Œç‚¹å‡»åˆ®å¼€æŒ‰é’®ï¼Œè¯•è¯•ä½ çš„è¿æ°”ï¼<br><small><i class="fas fa-exclamation-triangle"></i> æ³¨æ„ï¼šä¸­å¥–é‡‘é¢è¶…è¿‡4000å…ƒéœ€ç¼´çº³22%ç¨è´¹ï¼ˆå…¶ä¸­2%è½¬ä¸ºå…¬ç›Šé‡‘ï¼‰</small></p>
        
        <div id="identityRequiredNotice" class="identity-required-notice" style="display: none;">
            <i class="fas fa-id-card"></i>
            <span id="identityRequiredMessage"></span>
        </div>
        
        <div id="godLotteryInfo" class="god-lottery-info" style="display: none;">
            <i class="fas fa-crown"></i>
            <span id="godLotteryMessage"></span>
        </div>
        
        <div id="luckyKingInfo" class="lucky-king-info" style="display: none;">
            <i class="fas fa-crown"></i>ğŸŒŸ
            <span id="luckyKingMessage"></span>
        </div>
        
        <div id="welfareInfo" class="welfare-info" style="display: none;">
            <i class="fas fa-hands-helping"></i>
            <span id="welfareMessage"></span>
        </div>
        
        <div id="welfareBonus" class="welfare-bonus" style="display: none;">
            <i class="fas fa-gift"></i>
            <span id="welfareBonusMessage"></span>
        </div>
        
        <div id="limitWarning" class="limit-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="limitMessage"></span>
        </div>
        
        <div id="antiCodeInfo" class="anti-code" style="display: none;">
            <i class="fas fa-shield-alt"></i>
            <div id="antiCodeMessage"></div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0;">
                <div class="anti-code-code" id="antiCodeValue" onclick="copyAntiCode(this)"></div>
                <button class="anti-code-copy-btn" onclick="copyAntiCode(document.getElementById('antiCodeValue'))">
                    <i class="fas fa-copy"></i> å¤åˆ¶
                </button>
            </div>
            <div class="anti-code-info">
                <i class="fas fa-info-circle"></i> æ­¤é˜²ä¼ªç ç”¨äºéªŒè¯å½©ç¥¨çœŸä¼ªï¼Œè¯·å¦¥å–„ä¿ç®¡<br>
                <a href="anti_verify.html" target="_blank" style="color: #2e7d32; text-decoration: underline;">
                    <i class="fas fa-search"></i> ç‚¹å‡»è¿™é‡ŒéªŒè¯é˜²ä¼ªç 
                </a>
            </div>
        </div>
        
        <div class="user-stats">
            <div class="stat-item">
                <div class="stat-label">ç”¨æˆ·å</div>
                <div class="stat-value" id="statUsername">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å½“å‰ä½™é¢</div>
                <div class="stat-value" id="statBalance">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">è´­ä¹°æ¬¡æ•°</div>
                <div class="stat-value" id="statTickets">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç´¯è®¡ä¸­å¥–</div>
                <div class="stat-value" id="statWinnings">0å…ƒ</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç´¯è®¡ç¼´ç¨</div>
                <div class="stat-value" id="statTax">0å…ƒ</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å…¬ç›Šè´¡çŒ®</div>
                <div class="stat-value" id="statWelfare">0å…ƒ</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç¥è±ªå½©ç¥¨</div>
                <div class="stat-value" id="statGodTickets">0å¼ </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ¬§çš‡å¥–</div>
                <div class="stat-value" id="statLuckyKingTickets">0å¼ </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">èº«ä»½è®¤è¯</div>
                <div class="stat-value" id="statIdentity">æœªè®¤è¯</div>
            </div>
        </div>
        
        <div class="game-info">
            <div class="balance" id="currentBalance">0.00 å…ƒ</div>
            <p class="ticket-price" id="selectedTicketPrice">è¯·é€‰æ‹©å½©ç¥¨ç±»å‹</p>
            <p><i class="fas fa-info-circle"></i> è°¨æ…æŠ•æ³¨ï¼Œç†æ€§è´­å½© | <i class="fas fa-file-invoice-dollar"></i> ä¸­å¥–è¶…4000å…ƒéœ€ç¼´22%ç¨ï¼ˆå…¶ä¸­2%è½¬ä¸ºå…¬ç›Šé‡‘ï¼‰ | <i class="fas fa-id-card"></i> è´­ä¹°å½©ç¥¨éœ€è¦å®Œæˆèº«ä»½è®¤è¯ | <i class="fas fa-hands-helping"></i> å…¬ç›Šé‡‘æ»¡5ä¸‡èµ é€ç¥è±ªå½©ç¥¨è´­ä¹°æ¬¡æ•° | <i class="fas fa-shield-alt"></i> æ¯å¼ ä¸­å¥–å½©ç¥¨éƒ½æœ‰å”¯ä¸€é˜²ä¼ªç </p>
        </div>
        
        <div id="message" class="message"></div>
        
        <div class="lottery-types" id="lotteryTypes">
        </div>
        
        <div class="lottery-ticket">
            <div id="ticketCover">
                <h2><i class="fas fa-ticket-alt"></i> å¹¸è¿å½©ç¥¨</h2>
                <p>é€‰æ‹©å½©ç¥¨ç±»å‹åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ®å¼€</p>
                <div style="font-size: 48px; margin: 20px 0; opacity: 0.2;">
                    <i class="fas fa-question-circle"></i>
                </div>
            </div>
            <div id="prizeResult" class="prize-result" style="display: none;"></div>
        </div>
        
        <button onclick="buyTicket()" id="buyButton" class="buy-btn">
            <i class="fas fa-play"></i> è´­ä¹°å¹¶åˆ®å¼€å½©ç¥¨
        </button>
        
        <div class="history-list">
            <h3><i class="fas fa-history"></i> è¿‘æœŸè®°å½• <small>(å«ç¨è´¹åŠå…¬ç›Šé‡‘ä¿¡æ¯)</small></h3>
            <div id="historyList">
                <p style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-clock" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                    æš‚æ— è´­ä¹°è®°å½•
                </p>
            </div>
        </div>
        
        <div class="nav-links">
            <a href="index.html"><i class="fas fa-home"></i> è¿”å›é¦–é¡µ</a>
            <a href="account_management.html"><i class="fas fa-user-cog"></i> è´¦æˆ·ç®¡ç†</a>
            <a href="identity_verification.html"><i class="fas fa-id-card"></i> èº«ä»½è®¤è¯</a>
            <a href="second.html"><i class="fas fa-info-circle"></i> å½©ç¥¨è¯´æ˜</a>
            <a href="changelog.html"><i class="fas fa-history"></i> æ›´æ–°æ—¥å¿—</a>
            <a href="anti_verify.html" target="_blank"><i class="fas fa-shield-alt"></i> é˜²ä¼ªç éªŒè¯</a>
        </div>
    </div>
    <script>
        let currentUser = null;
        let selectedLotteryType = 'standard';
        let lotteryTypes = {};
        
        function formatAmount(amount) {
            if (amount === undefined || amount === null) {
                return "0å…ƒ";
            }
            
            const num = parseFloat(amount);
            if (isNaN(num)) {
                return "0å…ƒ";
            }
            
            if (num >= 100000) {
                return `${(num / 10000).toFixed(2)}ä¸‡å…ƒ`;
            } else {
                return `${num.toFixed(2)}å…ƒ`;
            }
        }
        
        function updateNetworkStatus(online) {
            const networkStatus = document.getElementById('networkStatus');
            if (online) {
                networkStatus.innerHTML = '<i class="fas fa-wifi"></i> ç½‘ç»œè¿æ¥æ­£å¸¸';
                networkStatus.className = 'network-status online';
                networkStatus.style.display = 'block';
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 3000);
            } else {
                networkStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                networkStatus.className = 'network-status';
                networkStatus.style.display = 'block';
            }
        }
        
        async function checkAuth() {
            try {
                updateNetworkStatus(true);
                const response = await fetch('/api/check_auth');
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.authenticated) {
                    currentUser = data;
                    await loadLotteryTypes();
                    updateUserInfo(data);
                    await loadUserInfo();
                    await updateGodLotteryInfo();
                    await updateLuckyKingInfo();
                    await updateWelfareInfo();
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                updateNetworkStatus(false);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢', 'error');
            }
        }
        
        async function checkIdentityStatus() {
            try {
                const response = await fetch('/api/check_identity_status');
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    const identityNotice = document.getElementById('identityRequiredNotice');
                    const identityMessage = document.getElementById('identityRequiredMessage');
                    const statIdentity = document.getElementById('statIdentity');
                    
                    statIdentity.textContent = data.id_verified ? 'å·²è®¤è¯' : 'æœªè®¤è¯';
                    
                    if (!data.id_verified) {
                        identityMessage.innerHTML = `
                            <strong>éœ€è¦èº«ä»½è®¤è¯ï¼</strong> è´­ä¹°æ‰€æœ‰å½©ç¥¨éƒ½éœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼ˆéœ€æ»¡16å²ä¸”ä¸è¶…è¿‡75å²ï¼‰ã€‚<br>
                            <button onclick="window.location.href='identity_verification.html'" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; width: auto; display: inline-block;">
                                <i class="fas fa-id-card"></i> å‰å¾€èº«ä»½è®¤è¯
                            </button>
                        `;
                        identityNotice.style.display = 'block';
                    } else {
                        identityNotice.style.display = 'none';
                    }
                    
                    return data.id_verified;
                }
                return false;
            } catch (error) {
                console.error('æ£€æŸ¥èº«ä»½è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }
        
        async function updateWelfareInfo() {
            try {
                const response = await fetch('/api/user_info');
                const data = await response.json();
                
                if (data.success) {
                    const welfareFund = data.public_welfare_fund || 0;
                    const welfareBonusGiven = data.welfare_bonus_given || 0;
                    const welfareInfo = document.getElementById('welfareInfo');
                    const welfareMessage = document.getElementById('welfareMessage');
                    const statWelfare = document.getElementById('statWelfare');
                    
                    statWelfare.textContent = formatAmount(welfareFund);
                    
                    if (welfareFund > 0) {
                        const formattedWelfareFund = formatAmount(welfareFund);
                        welfareMessage.innerHTML = `
                            <strong>å…¬ç›Šè´¡çŒ®ï¼š${formattedWelfareFund}</strong><br>
                            <small>â¤ï¸ æ‚¨çš„2%ç¨è´¹å·²è½¬ä¸ºå…¬ç›Šé‡‘ï¼Œæ¯ç´¯è®¡5ä¸‡å…ƒå¯å…‘æ¢ç¥è±ªå½©ç¥¨è´­ä¹°æ¬¡æ•°</small>
                        `;
                        welfareInfo.style.display = 'block';
                    } else {
                        welfareInfo.style.display = 'none';
                    }
                    
                    if (data.welfare_bonus) {
                        const bonusDiv = document.getElementById('welfareBonus');
                        const bonusMessage = document.getElementById('welfareBonusMessage');
                        const godMaxPurchases = data.god_max_purchases || 10;
                        
                        bonusMessage.innerHTML = `
                            <strong>ğŸ‰ å…¬ç›Šè´¡çŒ®å¥–åŠ±ï¼</strong><br>
                            <small>æ‚¨çš„å…¬ç›Šé‡‘ç´¯è®¡${formatAmount(welfareFund)}ï¼Œè·å¾—${data.welfare_bonus_count}æ¬¡ç¥è±ªå½©ç¥¨è´­ä¹°æ¬¡æ•°å¥–åŠ±ï¼</small><br>
                            <small>ç°åœ¨æœ€å¤šå¯è´­ä¹°${godMaxPurchases}å¼ ç¥è±ªå½©ç¥¨ï¼</small>
                        `;
                        bonusDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            bonusDiv.style.display = 'none';
                        }, 5000);
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°å…¬ç›Šé‡‘ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        async function updateGodLotteryInfo() {
            try {
                const response = await fetch('/api/user_info');
                const data = await response.json();
                
                if (data.success) {
                    const godPurchases = data.god_lottery_purchases || 0;
                    const godRemaining = data.god_remaining || 10;
                    const godDiscountRemaining = data.god_discount_remaining || 2;
                    const godMaxPurchases = data.god_max_purchases || 10;
                    const godInfo = document.getElementById('godLotteryInfo');
                    const godMessage = document.getElementById('godLotteryMessage');
                    const statGodTickets = document.getElementById('statGodTickets');
                    const limitWarning = document.getElementById('limitWarning');
                    const limitMessage = document.getElementById('limitMessage');
                    
                    statGodTickets.textContent = `${godPurchases}å¼ ï¼ˆå‰©ä½™${godRemaining}å¼ ï¼‰`;
                    
                    if (godRemaining <= 0) {
                        limitMessage.innerHTML = `<strong>âš ï¸ å·²è¾¾åˆ°è´­ä¹°ä¸Šé™ï¼</strong> ç¥è±ªå½©ç¥¨ç»ˆèº«é™è´­${godMaxPurchases}å¼ ï¼Œæ‚¨å·²è¾¾åˆ°è´­ä¹°ä¸Šé™`;
                        limitWarning.style.display = 'block';
                        godMessage.innerHTML = `
                            <strong><i class="fas fa-crown"></i> ç¥è±ªå½©ç¥¨å·²å”®ç½„</strong> æ‚¨å·²è´­ä¹°${godMaxPurchases}å¼ ç¥è±ªå½©ç¥¨<br>
                            <small>ğŸ¯ å·²è¾¾åˆ°ç»ˆèº«é™è´­ä¸Šé™ï¼Œæ— æ³•ç»§ç»­è´­ä¹°</small>
                        `;
                        godInfo.style.display = 'block';
                    } else if (godPurchases < 2) {
                        godMessage.innerHTML = `
                            <strong>ç¥è±ªå½©ç¥¨é™æ—¶ç‰¹æƒ ï¼</strong> å‰2å¼ ä»…éœ€200å…ƒ/å¼ <br>
                            <small>ğŸ¯ å¿…ä¸­å¥–ï¼æœ€ä½5000å…ƒï¼Œæœ€é«˜5äº¿å…ƒï¼æ‚¨å·²è´­ä¹°${godPurchases}å¼ ï¼Œå‰©ä½™${godDiscountRemaining}å¼ ä¼˜æƒ ï¼Œç»ˆèº«å‰©ä½™${godRemaining}å¼ </small>
                        `;
                        godInfo.style.display = 'block';
                        limitWarning.style.display = 'none';
                    } else if (godPurchases < godMaxPurchases) {
                        godMessage.innerHTML = `
                            <strong><i class="fas fa-crown"></i> ç¥è±ªå½©ç¥¨é«˜çº§ç‰ˆ</strong> æ‚¨å·²è´­ä¹°${godPurchases}å¼ ç¥è±ªå½©ç¥¨<br>
                            <small>ğŸ¯ å¿…ä¸­å¥–ï¼æœ€ä½5,000å…ƒï¼Œæœ€é«˜5äº¿å…ƒï¼é«˜çº§ä»·æ ¼ï¼š3,000å…ƒ/å¼ ï¼Œç»ˆèº«å‰©ä½™${godRemaining}å¼ </small>
                        `;
                        godInfo.style.display = 'block';
                        limitWarning.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°ç¥è±ªå½©ç¥¨ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        async function updateLuckyKingInfo() {
            try {
                const response = await fetch('/api/user_info');
                const data = await response.json();
                
                if (data.success) {
                    const luckyKingPurchases = data.lucky_king_purchases || 0;
                    const luckyKingRemaining = data.lucky_king_remaining || 5;
                    const luckyKingInfo = document.getElementById('luckyKingInfo');
                    const luckyKingMessage = document.getElementById('luckyKingMessage');
                    const statLuckyKingTickets = document.getElementById('statLuckyKingTickets');
                    const limitWarning = document.getElementById('limitWarning');
                    const limitMessage = document.getElementById('limitMessage');
                    
                    statLuckyKingTickets.textContent = `${luckyKingPurchases}å¼ ï¼ˆå‰©ä½™${luckyKingRemaining}å¼ ï¼‰`;
                    
                    if (luckyKingRemaining <= 0) {
                        limitMessage.innerHTML = `<strong>âš ï¸ å·²è¾¾åˆ°è´­ä¹°ä¸Šé™ï¼</strong> æ¬§çš‡å¥–ç»ˆèº«é™è´­5å¼ ï¼Œæ‚¨å·²è¾¾åˆ°è´­ä¹°ä¸Šé™`;
                        limitWarning.style.display = 'block';
                        luckyKingMessage.innerHTML = `
                            <strong><i class="fas fa-crown"></i>ğŸŒŸ æ¬§çš‡å¥–å·²å”®ç½„</strong> æ‚¨å·²è´­ä¹°5å¼ æ¬§çš‡å¥–<br>
                            <small>ğŸ¯ å·²è¾¾åˆ°ç»ˆèº«é™è´­ä¸Šé™ï¼Œæ— æ³•ç»§ç»­è´­ä¹°</small>
                        `;
                        luckyKingInfo.style.display = 'block';
                    } else if (luckyKingPurchases < 5) {
                        luckyKingMessage.innerHTML = `
                            <strong><i class="fas fa-crown"></i>ğŸŒŸ æ¬§çš‡å¥–éœ‡æ’¼ä¸Šçº¿ï¼</strong> å¿…ä¸­ä¸‡å…ƒå¤§å¥–ï¼<br>
                            <small>ğŸ¯ 99.5%æ¦‚ç‡è·å¾—10000å…ƒï¼Œ0.5%æ¦‚ç‡è·å¾—500ä¸‡å…ƒï¼æ‚¨å·²è´­ä¹°${luckyKingPurchases}å¼ ï¼Œç»ˆèº«å‰©ä½™${luckyKingRemaining}å¼ </small>
                        `;
                        luckyKingInfo.style.display = 'block';
                        limitWarning.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°æ¬§çš‡å¥–ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        async function loadLotteryTypes() {
            try {
                const response = await fetch('/api/lottery_types');
                const data = await response.json();
                
                if (data.success) {
                    lotteryTypes = data.lottery_types;
                    const container = document.getElementById('lotteryTypes');
                    container.innerHTML = '';
                    
                    Object.entries(lotteryTypes).forEach(([type, lottery]) => {
                        const card = document.createElement('div');
                        card.className = 'lottery-type-card';
                        
                        if (type === 'god') {
                            card.classList.add('god-lottery-card');
                        } else if (type === 'lucky_king') {
                            card.classList.add('lucky-king-card');
                        }
                        
                        if (type === selectedLotteryType) {
                            card.classList.add('selected');
                        }
                        card.onclick = () => selectLottery(type, card);
                        
                        let description = lottery.description;
                        let priceInfo = '';
                        let probabilityInfo = '';
                        
                        if (type === 'god') {
                            description = `ğŸ¯ å¿…ä¸­å¥–ï¼${lottery.description}`;
                            const maxDiscount = lottery.max_discount_purchases || 2;
                            const maxTotal = lottery.max_total_purchases || 10;
                            priceInfo = `å‰${maxDiscount}å¼ ï¼š${lottery.price}å…ƒ/å¼ ï¼Œä¹‹åï¼š${lottery.premium_price || 3000}å…ƒ/å¼ <br><small>ç»ˆèº«é™è´­${maxTotal}å¼ </small>`;
                            probabilityInfo = 'å¿…ä¸­å¥–ï¼æœ€ä½5,000å…ƒï¼Œæœ€é«˜5äº¿å…ƒ';
                        } else if (type === 'lucky_king') {
                            description = `ğŸ‘‘ğŸŒŸ æ¬§çš‡ä¸“å±ï¼Œå¿…ä¸­å¤§å¥–ï¼${lottery.description}`;
                            const maxTotal = lottery.max_total_purchases || 5;
                            priceInfo = `ä»·æ ¼ï¼š${lottery.price}å…ƒ/å¼ <br><small>ç»ˆèº«é™è´­${maxTotal}å¼ </small>`;
                            probabilityInfo = 'å¿…ä¸­å¥–ï¼99.5%å¾—1ä¸‡ï¼Œ0.5%å¾—500ä¸‡';
                        } else {
                            priceInfo = `ä»·æ ¼ï¼š${lottery.price}å…ƒ/å¼ `;
                            const totalPrizes = lottery.prizes || [];
                            const lastPrize = totalPrizes[totalPrizes.length - 1];
                            const loseProbability = lastPrize && lastPrize.name === 'æœªä¸­å¥–' ? lastPrize.probability || 0 : 0;
                            const winProbability = (1 - loseProbability) * 100;
                            probabilityInfo = `ä¸­å¥–æ¦‚ç‡ï¼š${winProbability.toFixed(2)}%`;
                        }
                        
                        card.innerHTML = `
                            <span class="lottery-icon">${lottery.icon}</span>
                            <div class="lottery-name">${lottery.name}</div>
                            <div class="lottery-price">
                                ${priceInfo}
                            </div>
                            <div class="lottery-description">${description}</div>
                            <div class="lottery-probability">
                                <i class="fas fa-chart-line"></i> ${probabilityInfo}
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    
                    updateTicketPrice();
                }
            } catch (error) {
                console.error('åŠ è½½å½©ç¥¨ç±»å‹å¤±è´¥:', error);
                updateNetworkStatus(false);
            }
        }
        
        function selectLottery(type, element) {
            selectedLotteryType = type;
            
            document.querySelectorAll('.lottery-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            element.classList.add('selected');
            
            updateTicketPrice();
            
            document.getElementById('ticketCover').style.display = 'block';
            document.getElementById('prizeResult').style.display = 'none';
            document.getElementById('antiCodeInfo').style.display = 'none';
        }
        
        async function updateTicketPrice() {
            const lottery = lotteryTypes[selectedLotteryType];
            if (lottery) {
                if (selectedLotteryType === 'god') {
                    try {
                        const response = await fetch('/api/user_info');
                        const data = await response.json();
                        
                        if (data.success) {
                            const godPurchases = data.god_lottery_purchases || 0;
                            const godRemaining = data.god_remaining || 10;
                            const godDiscountRemaining = data.god_discount_remaining || 2;
                            const godMaxPurchases = data.god_max_purchases || 10;
                            let currentPrice = 200;
                            let priceTag = '';
                            let priceInfo = '';
                            
                            if (godRemaining <= 0) {
                                currentPrice = 0;
                                priceInfo = `<span style="color: #dc3545;"><i class="fas fa-ban"></i> å·²å”®ç½„ï¼ˆè¾¾åˆ°è´­ä¹°ä¸Šé™${godMaxPurchases}å¼ ï¼‰</span>`;
                            } else if (godPurchases < 2) {
                                currentPrice = 200;
                                priceTag = `<span class="price-tag">ä¼˜æƒ ä»·</span>`;
                                priceInfo = `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>${currentPrice}å…ƒ/å¼ </strong> ${priceTag} (ç¬¬${godPurchases + 1}å¼ ï¼Œä¼˜æƒ å‰©ä½™${godDiscountRemaining}å¼ ï¼Œç»ˆèº«å‰©ä½™${godRemaining}å¼ )`;
                            } else {
                                currentPrice = 3000;
                                priceTag = `<span class="price-tag premium">é«˜çº§ä»·</span>`;
                                priceInfo = `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>${currentPrice}å…ƒ/å¼ </strong> ${priceTag} (ç¬¬${godPurchases + 1}å¼ ï¼Œç»ˆèº«å‰©ä½™${godRemaining}å¼ )`;
                            }
                            document.getElementById('selectedTicketPrice').innerHTML = priceInfo;
                        }
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        document.getElementById('selectedTicketPrice').innerHTML = 
                            `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>200å…ƒ/å¼ èµ·</strong>`;
                    }
                } else if (selectedLotteryType === 'lucky_king') {
                    try {
                        const response = await fetch('/api/user_info');
                        const data = await response.json();
                        
                        if (data.success) {
                            const luckyKingPurchases = data.lucky_king_purchases || 0;
                            const luckyKingRemaining = data.lucky_king_remaining || 5;
                            const currentPrice = 5000;
                            let priceTag = '';
                            let priceInfo = '';
                            
                            if (luckyKingRemaining <= 0) {
                                priceInfo = `<span style="color: #dc3545;"><i class="fas fa-ban"></i> å·²å”®ç½„ï¼ˆè¾¾åˆ°è´­ä¹°ä¸Šé™5å¼ ï¼‰</span>`;
                            } else {
                                priceTag = `<span class="price-tag lucky-king">æ¬§çš‡ä»·</span>`;
                                priceInfo = `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>${currentPrice}å…ƒ/å¼ </strong> ${priceTag} (ç¬¬${luckyKingPurchases + 1}å¼ ï¼Œç»ˆèº«å‰©ä½™${luckyKingRemaining}å¼ )`;
                            }
                            document.getElementById('selectedTicketPrice').innerHTML = priceInfo;
                        }
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        document.getElementById('selectedTicketPrice').innerHTML = 
                            `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>5000å…ƒ/å¼ </strong>`;
                    }
                } else {
                    document.getElementById('selectedTicketPrice').innerHTML = 
                        `<i class="fas fa-tag"></i> å½“å‰é€‰æ‹©ï¼š${lottery.name} - <strong>${lottery.price}å…ƒ/å¼ </strong>`;
                }
            }
        }
        
        function updateUserInfo(userData) {
            if (!userData) return;
            
            document.getElementById('statUsername').textContent = userData.username || '-';
            
            const balance = userData.balance || 0;
            document.getElementById('statBalance').textContent = formatAmount(balance);
            document.getElementById('currentBalance').textContent = formatAmount(balance);
        }
        
        async function buyTicket() {
            const messageDiv = document.getElementById('message');
            const buyButton = document.getElementById('buyButton');
            const lottery = lotteryTypes[selectedLotteryType];
            
            if (!lottery) {
                showMessage('è¯·å…ˆé€‰æ‹©å½©ç¥¨ç±»å‹', 'error');
                return;
            }
            
            const identityVerified = await checkIdentityStatus();
            if (!identityVerified) {
                showMessage('è´­ä¹°å½©ç¥¨éœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼ˆéœ€æ»¡16å²ä¸”ä¸è¶…è¿‡75å²ï¼‰', 'error');
                setTimeout(() => {
                    if (confirm('æ‚¨éœ€è¦å®Œæˆèº«ä»½è®¤è¯æ‰èƒ½è´­ä¹°å½©ç¥¨ï¼Œæ˜¯å¦å‰å¾€èº«ä»½è®¤è¯é¡µé¢ï¼Ÿ')) {
                        window.location.href = 'identity_verification.html';
                    }
                }, 1000);
                return;
            }
            
            if (selectedLotteryType === 'god') {
                try {
                    const response = await fetch('/api/user_info');
                    const data = await response.json();
                    
                    if (data.success && data.god_remaining !== undefined && data.god_remaining <= 0) {
                        showMessage(`ç¥è±ªå½©ç¥¨ç»ˆèº«é™è´­${data.god_max_purchases || 10}å¼ ï¼Œæ‚¨å·²è¾¾åˆ°è´­ä¹°ä¸Šé™ï¼`, 'error');
                        return;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç¥è±ªå½©ç¥¨å‰©ä½™æ¬¡æ•°å¤±è´¥:', error);
                }
            }
            
            if (selectedLotteryType === 'lucky_king') {
                try {
                    const response = await fetch('/api/user_info');
                    const data = await response.json();
                    
                    if (data.success && data.lucky_king_remaining !== undefined && data.lucky_king_remaining <= 0) {
                        showMessage('æ¬§çš‡å¥–ç»ˆèº«é™è´­5å¼ ï¼Œæ‚¨å·²è¾¾åˆ°è´­ä¹°ä¸Šé™ï¼', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æ¬§çš‡å¥–å‰©ä½™æ¬¡æ•°å¤±è´¥:', error);
                }
            }
            
            if (buyButton.disabled) return;
            
            buyButton.disabled = true;
            buyButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åˆ®å¼€...';
            
            try {
                const response = await fetch('/api/buy_ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: selectedLotteryType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (currentUser) {
                        currentUser.balance = data.balance;
                        updateUserInfo(currentUser);
                    }
                    
                    if (selectedLotteryType === 'god') {
                        await updateGodLotteryInfo();
                    } else if (selectedLotteryType === 'lucky_king') {
                        await updateLuckyKingInfo();
                    }
                    
                    await updateWelfareInfo();
                    
                    const ticketCover = document.getElementById('ticketCover');
                    const prizeResult = document.getElementById('prizeResult');
                    const antiCodeInfo = document.getElementById('antiCodeInfo');
                    const antiCodeValue = document.getElementById('antiCodeValue');
                    const antiCodeMessage = document.getElementById('antiCodeMessage');
                    
                    ticketCover.style.display = 'none';
                    prizeResult.style.display = 'block';
                    
                    let taxInfo = '';
                    if (data.tax_applied) {
                        const welfareFund = data.welfare_fund || 0;
                        const incomeTax = data.income_tax || 0;
                        taxInfo = `<div style="font-size: 0.9em; color: #DC3545; margin-top: 5px;">
                            <i class="fas fa-file-invoice-dollar"></i> ç¨è´¹ï¼š${data.tax}å…ƒ (å…¶ä¸­å…¬ç›Šé‡‘${welfareFund.toFixed(2)}å…ƒï¼Œä¸ªäººæ‰€å¾—ç¨${incomeTax.toFixed(2)}å…ƒ)
                        </div>`;
                    }
                    
                    const netAmount = data.net_amount || data.amount || 0;
                    const prizeName = data.prize || 'æœªä¸­å¥–';
                    
                    let lotteryIcon = '';
                    let resultStyle = '';
                    let priceInfo = '';
                    let remainingInfo = '';
                    
                    if (selectedLotteryType === 'god') {
                        lotteryIcon = 'ğŸ‘‘ ';
                        resultStyle = 'background: linear-gradient(135deg, #8B0000 0%, #FF4500 100%); color: #FFD700; border: 3px solid #FFD700;';
                        
                        if (data.is_premium_price) {
                            priceInfo = `<div style="font-size: 0.8em; color: #FFD700; margin-top: 5px;">
                                <i class="fas fa-crown"></i> é«˜çº§ç¥è±ªå½©ç¥¨ (3,000å…ƒ)
                            </div>`;
                        } else {
                            priceInfo = `<div style="font-size: 0.8em; color: #FFD700; margin-top: 5px;">
                                <i class="fas fa-crown"></i> ç¥è±ªå½©ç¥¨ (ç¬¬${data.god_purchases_count}å¼ ï¼Œ${data.ticket_price}å…ƒ)
                            </div>`;
                        }
                        
                        if (data.god_remaining !== undefined) {
                            remainingInfo = `<div style="font-size: 0.8em; color: #FFB6C1; margin-top: 5px;">
                                <i class="fas fa-shopping-cart"></i> ç»ˆèº«å‰©ä½™è´­ä¹°æ¬¡æ•°ï¼š${data.god_remaining}å¼ 
                            </div>`;
                        }
                    } else if (selectedLotteryType === 'lucky_king') {
                        lotteryIcon = 'ğŸ‘‘ğŸŒŸ ';
                        resultStyle = 'background: linear-gradient(135deg, #4B0082 0%, #8A2BE2 100%); color: #FFD700; border: 3px solid #FFD700;';
                        
                        priceInfo = `<div style="font-size: 0.8em; color: #FFD700; margin-top: 5px;">
                            <i class="fas fa-crown"></i>ğŸŒŸ æ¬§çš‡å¥– (ç¬¬${data.lucky_king_purchases_count}å¼ ï¼Œ5,000å…ƒ)
                        </div>`;
                        
                        if (data.lucky_king_remaining !== undefined) {
                            remainingInfo = `<div style="font-size: 0.8em; color: #E6E6FA; margin-top: 5px;">
                                <i class="fas fa-shopping-cart"></i> ç»ˆèº«å‰©ä½™è´­ä¹°æ¬¡æ•°ï¼š${data.lucky_king_remaining}å¼ 
                            </div>`;
                        }
                    } else {
                        resultStyle = `background-color: ${data.color || '#FFD700'}; color: #000; border-color: ${data.color || '#FFD700'};`;
                    }
                    
                    prizeResult.innerHTML = `
                        <div style="font-size: 2em; margin-bottom: 10px;">
                            ${lotteryIcon}${netAmount > 0 ? 'ğŸ‰' : (selectedLotteryType === 'god' || selectedLotteryType === 'lucky_king' ? 'ğŸ’°' : 'ğŸ˜Š')}
                        </div>
                        <div>${data.message || 'è´­ä¹°æˆåŠŸï¼'}</div>
                        <div style="font-size: 1.5em; margin-top: 10px; font-weight: bold;">
                            ${netAmount > 0 ? '+' + formatAmount(netAmount) : formatAmount(netAmount)}
                        </div>
                        ${taxInfo}
                        ${priceInfo}
                        ${remainingInfo}
                        <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.8;">
                            <i class="fas fa-ticket-alt"></i> ${data.lottery_name || 'æœªçŸ¥å½©ç¥¨'}
                        </div>
                    `;
                    prizeResult.style = resultStyle;
                    
                    // ä»…åœ¨ä¸­å¥–æ—¶æ˜¾ç¤ºé˜²ä¼ªç 
                    if (data.anti_code && netAmount > 0) {
                        antiCodeValue.textContent = data.anti_code;
                        antiCodeMessage.innerHTML = `<strong>ğŸ”’ å½©ç¥¨é˜²ä¼ªç </strong><br><small>ä¸­å¥–å½©ç¥¨ä¸“å±é˜²ä¼ªç </small>`;
                        antiCodeInfo.style.display = 'block';
                    } else {
                        antiCodeInfo.style.display = 'none';
                    }
                    
                    if (netAmount > 0) {
                        createCoinAnimation(netAmount);
                    }
                    
                    playSoundEffect(netAmount > 0 ? 'win' : 'lose');
                    
                    let message = `è´­ä¹°æˆåŠŸï¼å½©ç¥¨ï¼š${data.lottery_name || 'æœªçŸ¥å½©ç¥¨'}ï¼ŒèŠ±è´¹ï¼š${data.ticket_price || lottery.price}å…ƒ`;
                    if (selectedLotteryType === 'god') {
                        message += `ï¼Œç¬¬${data.god_purchases_count || 1}å¼ ç¥è±ªå½©ç¥¨`;
                        if (data.is_premium_price) {
                            message += ` (é«˜çº§ä»·æ ¼ï¼š3,000å…ƒ)`;
                        }
                        if (data.god_remaining !== undefined) {
                            message += `ï¼Œç»ˆèº«å‰©ä½™${data.god_remaining}å¼ `;
                        }
                    } else if (selectedLotteryType === 'lucky_king') {
                        message += `ï¼Œç¬¬${data.lucky_king_purchases_count || 1}å¼ æ¬§çš‡å¥–`;
                        if (data.lucky_king_remaining !== undefined) {
                            message += `ï¼Œç»ˆèº«å‰©ä½™${data.lucky_king_remaining}å¼ `;
                        }
                    }
                    if (data.tax_applied) {
                        const welfareFund = data.welfare_fund || 0;
                        const incomeTax = data.income_tax || 0;
                        message += `ï¼Œä¸­å¥–ï¼š${formatAmount(data.amount || 0)}ï¼Œå®å¾—ï¼š${formatAmount(netAmount)} (ç¼´ç¨${formatAmount(data.tax)}å…ƒï¼Œå…¶ä¸­å…¬ç›Šé‡‘${formatAmount(welfareFund)}å…ƒï¼Œä¸ªäººæ‰€å¾—ç¨${formatAmount(incomeTax)}å…ƒ)`;
                    } else {
                        message += `ï¼Œä¸­å¥–ï¼š${formatAmount(netAmount)}`;
                    }
                    
                    if (data.public_welfare_fund) {
                        message += `ï¼Œç´¯è®¡å…¬ç›Šè´¡çŒ®ï¼š${formatAmount(data.public_welfare_fund)}`;
                    }
                    
                    if (data.anti_code && netAmount > 0) {
                        message += `ï¼Œé˜²ä¼ªç ï¼š${data.anti_code}`;
                    }
                    
                    showMessage(message, netAmount > 0 ? 'success' : 'info');
                    
                    await loadUserInfo();
                    
                    await updateTicketPrice();
                    
                    updateNetworkStatus(true);
                    
                    if (data.welfare_bonus) {
                        const bonusDiv = document.getElementById('welfareBonus');
                        const bonusMessage = document.getElementById('welfareBonusMessage');
                        
                        bonusMessage.innerHTML = `
                            <strong>ğŸ‰ å…¬ç›Šè´¡çŒ®å¥–åŠ±ï¼</strong><br>
                            <small>æ‚¨çš„å…¬ç›Šé‡‘ç´¯è®¡${formatAmount(data.public_welfare_fund)}ï¼Œè·å¾—${data.welfare_bonus_count}æ¬¡ç¥è±ªå½©ç¥¨è´­ä¹°æ¬¡æ•°å¥–åŠ±ï¼</small><br>
                            <small>ç°åœ¨æœ€å¤šå¯è´­ä¹°${data.god_max_purchases}å¼ ç¥è±ªå½©ç¥¨ï¼</small>
                        `;
                        bonusDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            bonusDiv.style.display = 'none';
                        }, 5000);
                    }
                } else {
                    if (data.needs_identity_verification) {
                        showMessage(data.message || 'è´­ä¹°å½©ç¥¨éœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯', 'warning');
                        setTimeout(() => {
                            if (confirm('æ‚¨éœ€è¦å®Œæˆèº«ä»½è®¤è¯æ‰èƒ½è´­ä¹°å½©ç¥¨ï¼Œæ˜¯å¦å‰å¾€èº«ä»½è®¤è¯é¡µé¢ï¼Ÿ')) {
                                window.location.href = 'identity_verification.html';
                            }
                        }, 1000);
                    } else if (data.message && data.message.includes('è¾¾åˆ°è´­ä¹°ä¸Šé™')) {
                        showMessage(data.message, 'error');
                        if (selectedLotteryType === 'god') {
                            await updateGodLotteryInfo();
                        } else if (selectedLotteryType === 'lucky_king') {
                            await updateLuckyKingInfo();
                        }
                    } else {
                        showMessage(data.message || 'è´­ä¹°å¤±è´¥', 'error');
                    }
                    
                    if (data.message && data.message.includes('ä½™é¢ä¸è¶³')) {
                        setTimeout(() => {
                            const lotteryName = selectedLotteryType === 'god' ? 'ç¥è±ªå½©ç¥¨' : 
                                               (selectedLotteryType === 'lucky_king' ? 'æ¬§çš‡å¥–' : lottery.name);
                            const price = data.ticket_price || lottery.price;
                            if (confirm(`ä½™é¢ä¸è¶³è´­ä¹°${lotteryName}ï¼ˆ${price}å…ƒï¼‰ï¼Œæ˜¯å¦è¿”å›é¦–é¡µï¼Ÿ`)) {
                                window.location.href = 'index.html';
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('è´­ä¹°å½©ç¥¨å¤±è´¥:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                updateNetworkStatus(false);
            } finally {
                setTimeout(() => {
                    buyButton.disabled = false;
                    buyButton.innerHTML = '<i class="fas fa-play"></i> è´­ä¹°å¹¶åˆ®å¼€å½©ç¥¨';
                }, 2000);
            }
        }
        
        function copyAntiCode(element) {
            const antiCode = element.textContent;
            
            if (!antiCode) return;
            
            const textArea = document.createElement('textarea');
            textArea.value = antiCode;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalText = element.textContent;
                    const originalClass = element.className;
                    
                    element.textContent = 'å·²å¤åˆ¶ï¼';
                    element.className = 'anti-code-code copied';
                    
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.className = originalClass;
                    }, 1500);
                    
                    showMessage('é˜²ä¼ªç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                console.error('å¤åˆ¶å¤±è´¥:', err);
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function createCoinAnimation(amount) {
            const coinsCount = Math.min(Math.floor(amount / 10), 20);
            
            for (let i = 0; i < coinsCount; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'coin-animation';
                    coin.innerHTML = 'ğŸ’°';
                    coin.style.left = Math.random() * 100 + 'vw';
                    coin.style.top = '-50px';
                    coin.style.fontSize = (20 + Math.random() * 20) + 'px';
                    
                    document.body.appendChild(coin);
                    
                    setTimeout(() => {
                        coin.remove();
                    }, 2000);
                }, i * 100);
            }
        }
        
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user_info');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('statTickets').textContent = data.total_tickets_bought || 0;
                    
                    document.getElementById('statWinnings').textContent = data.total_winnings_formatted || formatAmount(data.total_winnings || 0);
                    document.getElementById('statTax').textContent = data.total_tax_paid_formatted || formatAmount(data.total_tax_paid || 0);
                    document.getElementById('statWelfare').textContent = data.public_welfare_fund_formatted || formatAmount(data.public_welfare_fund || 0);
                    
                    const godPurchases = data.god_lottery_purchases || 0;
                    const godRemaining = data.god_remaining || 10;
                    const godMaxPurchases = data.god_max_purchases || 10;
                    document.getElementById('statGodTickets').textContent = `${godPurchases}å¼ ï¼ˆå‰©ä½™${godRemaining}å¼ ï¼‰`;
                    
                    const luckyKingPurchases = data.lucky_king_purchases || 0;
                    const luckyKingRemaining = data.lucky_king_remaining || 5;
                    document.getElementById('statLuckyKingTickets').textContent = `${luckyKingPurchases}å¼ ï¼ˆå‰©ä½™${luckyKingRemaining}å¼ ï¼‰`;
                    
                    document.getElementById('statIdentity').textContent = 
                        data.id_verified ? 'å·²è®¤è¯' : 'æœªè®¤è¯';
                    
                    if (currentUser && data.balance) {
                        currentUser.balance = data.balance;
                        updateUserInfo(currentUser);
                    }
                    
                    const historyList = document.getElementById('historyList');
                    
                    if (data.history && data.history.length > 0) {
                        historyList.innerHTML = '';
                        data.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            
                            let taxInfo = '';
                            if (item.tax_applied) {
                                const welfareFund = item.welfare_fund || 0;
                                const incomeTax = item.income_tax || 0;
                                taxInfo = `<div style="font-size: 0.8em; color: #DC3545; margin-top: 3px;">
                                    <i class="fas fa-file-invoice-dollar"></i> ç¨è´¹ï¼š${formatAmount(item.tax || 0)} (å…¬ç›Šé‡‘${formatAmount(welfareFund)}ï¼Œä¸ªç¨${formatAmount(incomeTax)})
                                </div>`;
                            }
                            
                            let godTag = '';
                            let luckyKingTag = '';
                            let remainingInfo = '';
                            if (item.god_lottery) {
                                if (item.god_price_tier === 'premium') {
                                    godTag = `<span style="background: #FF4500; color: #FFFFFF; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;"><i class="fas fa-crown"></i> é«˜çº§ç¥è±ª</span>`;
                                } else {
                                    godTag = `<span style="background: #FFD700; color: #8B0000; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;"><i class="fas fa-crown"></i> ç¥è±ª</span>`;
                                }
                                
                                if (item.god_remaining !== undefined) {
                                    remainingInfo = `<div style="font-size: 0.7em; color: #666; margin-top: 2px;">
                                        <i class="fas fa-box"></i> å‰©ä½™ï¼š${item.god_remaining}å¼ 
                                    </div>`;
                                }
                            } else if (item.lucky_king_lottery) {
                                luckyKingTag = `<span style="background: #8A2BE2; color: #FFFFFF; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;"><i class="fas fa-crown"></i>ğŸŒŸ æ¬§çš‡</span>`;
                                
                                if (item.lucky_king_remaining !== undefined) {
                                    remainingInfo = `<div style="font-size: 0.7em; color: #666; margin-top: 2px;">
                                        <i class="fas fa-box"></i> å‰©ä½™ï¼š${item.lucky_king_remaining}å¼ 
                                    </div>`;
                                }
                            }
                            
                            let antiInfo = '';
                            if (item.anti_code) {
                                antiInfo = `<div style="font-size: 0.7em; color: #2e7d32; margin-top: 3px;">
                                    <i class="fas fa-shield-alt"></i> é˜²ä¼ªç ï¼š${item.anti_code}
                                </div>`;
                            }
                            
                            historyItem.innerHTML = `
                                <div style="text-align: left; flex: 1;">
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                                        <i class="far fa-clock"></i> ${item.time || ''}
                                    </div>
                                    <div style="font-weight: bold; color: #333;">
                                        <i class="fas fa-ticket-alt"></i> ${item.lottery_name || ''} ${godTag}${luckyKingTag}
                                    </div>
                                    <div style="font-size: 0.8em; color: #999;">
                                        èŠ±è´¹ï¼š${item.ticket_cost || 0}å…ƒ
                                    </div>
                                    ${remainingInfo}
                                    ${antiInfo}
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: ${item.color || '#333'}; font-size: 1.1em;">
                                        ${(item.net_amount || 0) > 0 ? '+' + formatAmount(item.net_amount || 0) : formatAmount(item.net_amount || 0)}
                                    </div>
                                    <div style="font-size: 0.85em; color: #999;">
                                        ${item.prize_name || ''}
                                    </div>
                                    ${taxInfo}
                                </div>
                            `;
                            historyList.appendChild(historyItem);
                        });
                    } else {
                        historyList.innerHTML = `
                            <p style="text-align: center; color: #666; padding: 30px;">
                                <i class="fas fa-clock" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                                æš‚æ— è´­ä¹°è®°å½•
                            </p>
                        `;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                updateNetworkStatus(false);
            }
        }
        
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
                showMessage('ç™»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            const hideTime = type === 'info' ? 5000 : 3000;
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, hideTime);
        }
        
        function playSoundEffect(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (type === 'win') {
                    playBeep(audioContext, 800, 0.3, 0.1);
                    setTimeout(() => playBeep(audioContext, 1200, 0.2, 0.2), 100);
                    setTimeout(() => playBeep(audioContext, 1600, 0.1, 0.3), 200);
                } else {
                    playBeep(audioContext, 400, 0.2, 0.1);
                    setTimeout(() => playBeep(audioContext, 300, 0.1, 0.2), 100);
                }
            } catch (e) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥');
            }
        }
        
        function playBeep(audioContext, frequency, volume, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        window.onload = async function() {
            await checkAuth();
            await checkIdentityStatus();
        };
    </script>
</body>
</html>